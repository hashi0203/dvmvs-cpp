#pragma once

typedef unsigned short qtint;

constexpr int tbbit = 10;
constexpr int tbshift = 7;
constexpr int sigshift = 20;
constexpr qaint celu_table[1024] = {0, -8160, -16257, -24290, -32261, -40170, -48018, -55804, -63530, -71196, -78802, -86349, -93837, -101267, -108639, -115953, -123211, -130412, -137557, -144647, -151681, -158661, -165586, -172458, -179276, -186041, -192753, -199413, -206022, -212578, -219084, -225539, -231944, -238299, -244605, -250861, -257069, -263229, -269340, -275405, -281421, -287391, -293315, -299193, -305024, -310811, -316552, -322249, -327901, -333509, -339074, -344595, -350074, -355510, -360903, -366255, -371564, -376833, -382061, -387247, -392394, -397500, -402567, -407594, -412583, -417532, -422443, -427315, -432150, -436947, -441707, -446429, -451115, -455765, -460378, -464956, -469497, -474004, -478475, -482912, -487314, -491681, -496015, -500315, -504582, -508815, -513016, -517184, -521319, -525422, -529493, -533533, -537541, -541518, -545464, -549379, -553264, -557118, -560943, -564738, -568503, -572239, -575946, -579624, -583273, -586894, -590487, -594052, -597589, -601099, -604581, -608036, -611464, -614866, -618241, -621590, -624913, -628210, -631481, -634727, -637948, -641143, -644314, -647460, -650581, -653679, -656752, -659801, -662826, -665828, -668807, -671762, -674695, -677604, -680491, -683356, -686198, -689018, -691816, -694592, -697347, -700080, -702792, -705483, -708153, -710802, -713431, -716039, -718627, -721195, -723742, -726270, -728778, -731267, -733736, -736186, -738618, -741030, -743423, -745798, -748154, -750492, -752812, -755113, -757397, -759663, -761911, -764142, -766356, -768552, -770731, -772893, -775039, -777167, -779279, -781375, -783454, -785518, -787565, -789596, -791611, -793611, -795595, -797564, -799517, -801456, -803379, -805287, -807180, -809059, -810923, -812772, -814607, -816428, -818234, -820027, -821806, -823570, -825321, -827059, -828783, -830493, -832190, -833874, -835545, -837203, -838848, -840480, -842099, -843706, -845300, -846882, -848452, -850009, -851554, -853088, -854609, -856118, -857616, -859102, -860577, -862040, -863491, -864932, -866361, -867779, -869186, -870582, -871967, -873341, -874705, -876058, -877401, -878733, -880055, -881366, -882667, -883958, -885239, -886510, -887772, -889023, -890265, -891497, -892719, -893932, -895135, -896330, -897514, -898690, -899856, -901014, -902162, -903301, -904432, -905554, -906667, -907771, -908867, -909954, -911033, -912103, -913165, -914219, -915265, -916302, -917331, -918353, -919366, -920372, -921369, -922359, -923341, -924316, -925283, -926243, -927195, -928139, -929076, -930006, -930929, -931845, -932753, -933654, -934549, -935436, -936316, -937190, -938057, -938917, -939770, -940617, -941457, -942291, -943118, -943939, -944753, -945561, -946363, -947158, -947947, -948730, -949507, -950278, -951043, -951802, -952555, -953303, -954044, -954780, -955510, -956234, -956952, -957665, -958373, -959075, -959771, -960462, -961148, -961829, -962504, -963173, -963838, -964498, -965152, -965801, -966445, -967084, -967719, -968348, -968972, -969592, -970206, -970816, -971421, -972022, -972617, -973209, -973795, -974377, -974954, -975527, -976096, -976660, -977220, -977775, -978326, -978872, -979415, -979953, -980487, -981017, -981543, -982064, -982582, -983096, -983605, -984111, -984612, -985110, -985604, -986094, -986580, -987063, -987542, -988017, -988488, -988955, -989419, -989880, -990337, -990790, -991239, -991686, -992128, -992568, -993004, -993436, -993865, -994291, -994713, -995132, -995548, -995961, -996370, -996777, -997180, -997580, -997977, -998370, -998761, -999149, -999533, -999915, -1000294, -1000670, -1001042, -1001412, -1001779, -1002143, -1002505, -1002863, -1003219, -1003572, -1003922, -1004270, -1004615, -1004957, -1005296, -1005633, -1005967, -1006299, -1006628, -1006954, -1007278, -1007599, -1007918, -1008235, -1008549, -1008860, -1009169, -1009476, -1009780, -1010082, -1010382, -1010679, -1010974, -1011266, -1011557, -1011845, -1012131, -1012414, -1012696, -1012975, -1013252, -1013527, -1013800, -1014070, -1014339, -1014605, -1014870, -1015132, -1015392, -1015650, -1015907, -1016161, -1016413, -1016663, -1016912, -1017158, -1017403, -1017645, -1017886, -1018125, -1018362, -1018597, -1018830, -1019062, -1019291, -1019519, -1019745, -1019970, -1020192, -1020413, -1020632, -1020850, -1021066, -1021280, -1021492, -1021703, -1021912, -1022120, -1022325, -1022530, -1022732, -1022934, -1023133, -1023331, -1023528, -1023722, -1023916, -1024108, -1024298, -1024487, -1024675, -1024861, -1025045, -1025228, -1025410, -1025590, -1025769, -1025947, -1026123, -1026297, -1026471, -1026643, -1026813, -1026983, -1027151, -1027318, -1027483, -1027647, -1027810, -1027972, -1028132, -1028291, -1028449, -1028606, -1028761, -1028915, -1029068, -1029220, -1029371, -1029520, -1029668, -1029816, -1029962, -1030106, -1030250, -1030393, -1030534, -1030675, -1030814, -1030952, -1031089, -1031225, -1031360, -1031494, -1031627, -1031759, -1031890, -1032020, -1032149, -1032277, -1032403, -1032529, -1032654, -1032778, -1032901, -1033023, -1033144, -1033264, -1033383, -1033502, -1033619, -1033735, -1033851, -1033965, -1034079, -1034192, -1034304, -1034415, -1034525, -1034634, -1034743, -1034851, -1034957, -1035063, -1035169, -1035273, -1035376, -1035479, -1035581, -1035682, -1035782, -1035882, -1035981, -1036079, -1036176, -1036273, -1036368, -1036463, -1036558, -1036651, -1036744, -1036836, -1036927, -1037018, -1037108, -1037197, -1037286, -1037374, -1037461, -1037547, -1037633, -1037718, -1037803, -1037887, -1037970, -1038052, -1038134, -1038215, -1038296, -1038376, -1038455, -1038534, -1038612, -1038690, -1038767, -1038843, -1038919, -1038994, -1039069, -1039143, -1039216, -1039289, -1039361, -1039433, -1039504, -1039575, -1039645, -1039714, -1039783, -1039852, -1039919, -1039987, -1040054, -1040120, -1040186, -1040251, -1040316, -1040380, -1040444, -1040507, -1040570, -1040632, -1040694, -1040755, -1040816, -1040877, -1040937, -1040996, -1041055, -1041114, -1041172, -1041229, -1041286, -1041343, -1041399, -1041455, -1041511, -1041566, -1041620, -1041674, -1041728, -1041781, -1041834, -1041887, -1041939, -1041990, -1042042, -1042093, -1042143, -1042193, -1042243, -1042292, -1042341, -1042389, -1042438, -1042485, -1042533, -1042580, -1042626, -1042673, -1042719, -1042764, -1042810, -1042854, -1042899, -1042943, -1042987, -1043030, -1043074, -1043116, -1043159, -1043201, -1043243, -1043284, -1043326, -1043366, -1043407, -1043447, -1043487, -1043527, -1043566, -1043605, -1043644, -1043682, -1043720, -1043758, -1043795, -1043833, -1043870, -1043906, -1043942, -1043979, -1044014, -1044050, -1044085, -1044120, -1044155, -1044189, -1044223, -1044257, -1044291, -1044324, -1044357, -1044390, -1044423, -1044455, -1044487, -1044519, -1044550, -1044582, -1044613, -1044644, -1044674, -1044705, -1044735, -1044765, -1044794, -1044824, -1044853, -1044882, -1044911, -1044939, -1044967, -1044996, -1045023, -1045051, -1045078, -1045106, -1045133, -1045159, -1045186, -1045212, -1045239, -1045265, -1045290, -1045316, -1045341, -1045366, -1045391, -1045416, -1045441, -1045465, -1045489, -1045513, -1045537, -1045561, -1045584, -1045608, -1045631, -1045654, -1045676, -1045699, -1045721, -1045744, -1045766, -1045788, -1045809, -1045831, -1045852, -1045873, -1045894, -1045915, -1045936, -1045956, -1045977, -1045997, -1046017, -1046037, -1046057, -1046076, -1046096, -1046115, -1046134, -1046153, -1046172, -1046191, -1046209, -1046228, -1046246, -1046264, -1046282, -1046300, -1046318, -1046335, -1046353, -1046370, -1046387, -1046404, -1046421, -1046438, -1046455, -1046471, -1046488, -1046504, -1046520, -1046536, -1046552, -1046568, -1046583, -1046599, -1046614, -1046629, -1046644, -1046659, -1046674, -1046689, -1046704, -1046718, -1046733, -1046747, -1046761, -1046776, -1046790, -1046804, -1046817, -1046831, -1046845, -1046858, -1046871, -1046885, -1046898, -1046911, -1046924, -1046937, -1046949, -1046962, -1046975, -1046987, -1047000, -1047012, -1047024, -1047036, -1047048, -1047060, -1047072, -1047083, -1047095, -1047107, -1047118, -1047129, -1047141, -1047152, -1047163, -1047174, -1047185, -1047196, -1047206, -1047217, -1047228, -1047238, -1047248, -1047259, -1047269, -1047279, -1047289, -1047299, -1047309, -1047319, -1047329, -1047339, -1047348, -1047358, -1047367, -1047377, -1047386, -1047395, -1047404, -1047414, -1047423, -1047432, -1047441, -1047449, -1047458, -1047467, -1047475, -1047484, -1047493, -1047501, -1047509, -1047518, -1047526, -1047534, -1047542, -1047550, -1047558, -1047566, -1047574, -1047582, -1047589, -1047597, -1047605, -1047612, -1047620, -1047627, -1047635, -1047642, -1047649, -1047656, -1047664, -1047671, -1047678, -1047685, -1047692, -1047699, -1047705, -1047712, -1047719, -1047726, -1047732, -1047739, -1047745, -1047752, -1047758, -1047765, -1047771, -1047777, -1047783, -1047789, -1047796, -1047802, -1047808, -1047814, -1047820, -1047825, -1047831, -1047837, -1047843, -1047849, -1047854, -1047860, -1047865, -1047871, -1047876, -1047882, -1047887, -1047893, -1047898, -1047903, -1047908, -1047914, -1047919, -1047924, -1047929, -1047934, -1047939, -1047944, -1047949, -1047954, -1047959, -1047963, -1047968, -1047973, -1047978, -1047982, -1047987, -1047992, -1047996, -1048001, -1048005, -1048009, -1048014, -1048018, -1048023, -1048027, -1048031, -1048035, -1048040, -1048044, -1048048, -1048052, -1048056, -1048060, -1048064, -1048068, -1048072, -1048076, -1048080, -1048084, -1048088, -1048091, -1048095, -1048099, -1048103, -1048106, -1048110, -1048114, -1048117, -1048121, -1048124, -1048128, -1048131, -1048135, -1048138, -1048142, -1048145, -1048148, -1048152, -1048155, -1048158, -1048162, -1048165, -1048168, -1048171, -1048174, -1048177, -1048181, -1048184, -1048187, -1048190, -1048193, -1048196, -1048199, -1048202, -1048204, -1048207, -1048210, -1048213, -1048216, -1048219, -1048221};
constexpr qaint Sigmoid_table[1024] = {524288, 526336, 528384, 530432, 532479, 534527, 536574, 538620, 540667, 542712, 544758, 546802, 548846, 550889, 552931, 554973, 557013, 559053, 561091, 563129, 565165, 567200, 569233, 571266, 573297, 575326, 577354, 579380, 581404, 583427, 585448, 587467, 589485, 591500, 593513, 595525, 597534, 599541, 601545, 603548, 605548, 607545, 609540, 611533, 613523, 615510, 617495, 619477, 621456, 623432, 625405, 627376, 629343, 631307, 633268, 635226, 637181, 639132, 641080, 643025, 644966, 646904, 648838, 650769, 652696, 654619, 656539, 658455, 660367, 662275, 664179, 666079, 667975, 669867, 671755, 673639, 675519, 677394, 679266, 681133, 682995, 684853, 686707, 688556, 690401, 692241, 694076, 695907, 697734, 699555, 701372, 703184, 704991, 706793, 708591, 710383, 712170, 713953, 715730, 717503, 719270, 721032, 722789, 724541, 726288, 728029, 729765, 731496, 733221, 734941, 736656, 738365, 740069, 741768, 743460, 745148, 746830, 748506, 750176, 751841, 753501, 755155, 756803, 758445, 760082, 761712, 763338, 764957, 766570, 768178, 769780, 771376, 772966, 774551, 776129, 777702, 779268, 780829, 782383, 783932, 785475, 787012, 788542, 790067, 791586, 793098, 794605, 796106, 797600, 799088, 800571, 802047, 803517, 804981, 806439, 807891, 809337, 810776, 812210, 813637, 815058, 816473, 817882, 819285, 820681, 822071, 823456, 824834, 826206, 827572, 828931, 830285, 831632, 832973, 834308, 835637, 836959, 838276, 839586, 840891, 842189, 843481, 844767, 846046, 847320, 848587, 849849, 851104, 852353, 853596, 854833, 856064, 857289, 858508, 859720, 860927, 862128, 863322, 864511, 865694, 866870, 868041, 869205, 870364, 871517, 872663, 873804, 874939, 876068, 877191, 878308, 879419, 880525, 881624, 882718, 883806, 884888, 885964, 887035, 888100, 889159, 890212, 891259, 892301, 893337, 894368, 895392, 896412, 897425, 898433, 899435, 900432, 901423, 902408, 903388, 904363, 905332, 906295, 907253, 908206, 909153, 910095, 911031, 911962, 912887, 913808, 914723, 915632, 916536, 917435, 918329, 919218, 920101, 920979, 921852, 922720, 923583, 924440, 925293, 926140, 926982, 927820, 928652, 929479, 930301, 931119, 931931, 932739, 933541, 934339, 935132, 935920, 936703, 937481, 938255, 939024, 939788, 940547, 941302, 942052, 942797, 943538, 944274, 945005, 945732, 946455, 947173, 947886, 948595, 949299, 949999, 950695, 951386, 952073, 952755, 953433, 954107, 954776, 955441, 956102, 956759, 957411, 958059, 958703, 959343, 959979, 960611, 961238, 961862, 962481, 963096, 963708, 964315, 964918, 965518, 966113, 966705, 967293, 967877, 968457, 969033, 969605, 970174, 970739, 971300, 971857, 972411, 972961, 973507, 974050, 974589, 975124, 975656, 976184, 976709, 977230, 977748, 978262, 978773, 979280, 979784, 980285, 980782, 981276, 981766, 982253, 982737, 983217, 983694, 984168, 984639, 985106, 985571, 986032, 986490, 986944, 987396, 987844, 988290, 988732, 989172, 989608, 990041, 990471, 990899, 991323, 991745, 992163, 992579, 992991, 993401, 993808, 994212, 994613, 995012, 995408, 995801, 996191, 996578, 996963, 997345, 997724, 998101, 998475, 998846, 999215, 999581, 999945, 1000306, 1000664, 1001020, 1001374, 1001725, 1002073, 1002419, 1002763, 1003104, 1003442, 1003779, 1004112, 1004444, 1004773, 1005100, 1005424, 1005746, 1006066, 1006383, 1006699, 1007012, 1007322, 1007631, 1007937, 1008241, 1008543, 1008843, 1009140, 1009436, 1009729, 1010020, 1010310, 1010597, 1010881, 1011164, 1011445, 1011724, 1012001, 1012276, 1012548, 1012819, 1013088, 1013355, 1013620, 1013883, 1014144, 1014403, 1014661, 1014916, 1015170, 1015421, 1015671, 1015919, 1016166, 1016410, 1016653, 1016894, 1017133, 1017370, 1017606, 1017840, 1018072, 1018303, 1018531, 1018759, 1018984, 1019208, 1019430, 1019651, 1019870, 1020087, 1020303, 1020517, 1020729, 1020940, 1021150, 1021358, 1021564, 1021769, 1021972, 1022174, 1022374, 1022573, 1022771, 1022967, 1023161, 1023354, 1023546, 1023736, 1023925, 1024112, 1024298, 1024482, 1024666, 1024848, 1025028, 1025207, 1025385, 1025562, 1025737, 1025911, 1026083, 1026255, 1026425, 1026593, 1026761, 1026927, 1027092, 1027256, 1027419, 1027580, 1027740, 1027899, 1028057, 1028213, 1028369, 1028523, 1028676, 1028828, 1028979, 1029129, 1029277, 1029425, 1029571, 1029716, 1029860, 1030003, 1030145, 1030286, 1030426, 1030565, 1030703, 1030839, 1030975, 1031110, 1031244, 1031376, 1031508, 1031639, 1031768, 1031897, 1032025, 1032151, 1032277, 1032402, 1032526, 1032649, 1032771, 1032892, 1033013, 1033132, 1033250, 1033368, 1033485, 1033600, 1033715, 1033829, 1033942, 1034055, 1034166, 1034277, 1034387, 1034495, 1034604, 1034711, 1034817, 1034923, 1035028, 1035132, 1035235, 1035338, 1035440, 1035540, 1035641, 1035740, 1035839, 1035937, 1036034, 1036130, 1036226, 1036321, 1036415, 1036509, 1036602, 1036694, 1036785, 1036876, 1036966, 1037055, 1037144, 1037232, 1037319, 1037406, 1037492, 1037577, 1037662, 1037746, 1037830, 1037912, 1037994, 1038076, 1038157, 1038237, 1038317, 1038396, 1038474, 1038552, 1038630, 1038706, 1038782, 1038858, 1038933, 1039007, 1039081, 1039154, 1039227, 1039299, 1039370, 1039441, 1039512, 1039582, 1039651, 1039720, 1039788, 1039856, 1039924, 1039990, 1040057, 1040122, 1040188, 1040252, 1040317, 1040380, 1040444, 1040507, 1040569, 1040631, 1040692, 1040753, 1040813, 1040873, 1040933, 1040992, 1041050, 1041109, 1041166, 1041224, 1041280, 1041337, 1041393, 1041448, 1041503, 1041558, 1041612, 1041666, 1041720, 1041773, 1041825, 1041877, 1041929, 1041981, 1042032, 1042082, 1042132, 1042182, 1042232, 1042281, 1042329, 1042378, 1042426, 1042473, 1042521, 1042567, 1042614, 1042660, 1042706, 1042751, 1042796, 1042841, 1042885, 1042929, 1042973, 1043017, 1043060, 1043102, 1043145, 1043187, 1043228, 1043270, 1043311, 1043352, 1043392, 1043432, 1043472, 1043512, 1043551, 1043590, 1043628, 1043667, 1043705, 1043743, 1043780, 1043817, 1043854, 1043891, 1043927, 1043963, 1043999, 1044034, 1044069, 1044104, 1044139, 1044173, 1044207, 1044241, 1044275, 1044308, 1044341, 1044374, 1044407, 1044439, 1044471, 1044503, 1044534, 1044566, 1044597, 1044628, 1044658, 1044689, 1044719, 1044749, 1044778, 1044808, 1044837, 1044866, 1044895, 1044923, 1044952, 1044980, 1045008, 1045035, 1045063, 1045090, 1045117, 1045144, 1045171, 1045197, 1045223, 1045249, 1045275, 1045301, 1045326, 1045351, 1045376, 1045401, 1045426, 1045450, 1045474, 1045498, 1045522, 1045546, 1045570, 1045593, 1045616, 1045639, 1045662, 1045684, 1045707, 1045729, 1045751, 1045773, 1045795, 1045816, 1045838, 1045859, 1045880, 1045901, 1045922, 1045943, 1045963, 1045983, 1046003, 1046023, 1046043, 1046063, 1046082, 1046102, 1046121, 1046140, 1046159, 1046178, 1046196, 1046215, 1046233, 1046251, 1046269, 1046287, 1046305, 1046323, 1046340, 1046358, 1046375, 1046392, 1046409, 1046426, 1046442, 1046459, 1046475, 1046492, 1046508, 1046524, 1046540, 1046556, 1046571, 1046587, 1046602, 1046618, 1046633, 1046648, 1046663, 1046678, 1046693, 1046707, 1046722, 1046736, 1046750, 1046765, 1046779, 1046793, 1046807, 1046820, 1046834, 1046847, 1046861, 1046874, 1046887, 1046901, 1046914, 1046926, 1046939, 1046952, 1046965, 1046977, 1046990, 1047002, 1047014, 1047026, 1047038, 1047050, 1047062, 1047074, 1047086, 1047097, 1047109, 1047120, 1047131, 1047143, 1047154, 1047165, 1047176, 1047187, 1047197, 1047208, 1047219, 1047229, 1047240, 1047250, 1047260, 1047271, 1047281, 1047291, 1047301, 1047311, 1047321, 1047330, 1047340, 1047350, 1047359, 1047369, 1047378, 1047387, 1047397, 1047406, 1047415, 1047424, 1047433, 1047442, 1047451, 1047459, 1047468, 1047477, 1047485, 1047494, 1047502, 1047510, 1047519, 1047527, 1047535, 1047543, 1047551, 1047559, 1047567, 1047575, 1047583, 1047590, 1047598, 1047606, 1047613, 1047621, 1047628, 1047635, 1047643, 1047650, 1047657, 1047664, 1047671, 1047679, 1047686, 1047692, 1047699, 1047706, 1047713, 1047720, 1047726, 1047733, 1047739, 1047746, 1047752, 1047759, 1047765, 1047771, 1047778, 1047784, 1047790, 1047796, 1047802, 1047808, 1047814, 1047820, 1047826, 1047832, 1047838, 1047843, 1047849, 1047855, 1047860, 1047866, 1047871, 1047877, 1047882, 1047888, 1047893, 1047898, 1047904, 1047909, 1047914, 1047919, 1047924, 1047929, 1047934, 1047939, 1047944, 1047949, 1047954, 1047959, 1047964, 1047969, 1047973, 1047978, 1047983, 1047987, 1047992, 1047996, 1048001, 1048005, 1048010, 1048014, 1048019, 1048023, 1048027, 1048031, 1048036, 1048040, 1048044, 1048048, 1048052, 1048056, 1048060, 1048064, 1048068, 1048072, 1048076, 1048080, 1048084, 1048088, 1048092, 1048095, 1048099, 1048103, 1048107, 1048110, 1048114, 1048117, 1048121, 1048125, 1048128, 1048132, 1048135, 1048138, 1048142, 1048145, 1048149, 1048152, 1048155, 1048158, 1048162, 1048165, 1048168, 1048171, 1048174, 1048178, 1048181, 1048184, 1048187, 1048190, 1048193, 1048196, 1048199, 1048202, 1048205, 1048207, 1048210, 1048213, 1048216, 1048219, 1048222};

void ReLU(qaint* x, const int channels, const int height, const int width) {
    const int xshift = oin_shifts[other_cnt];
    const int yshift = oout_shifts[other_cnt];
    print_neg_shift("relu", "xshift", xshift);
    print_neg_shift("relu", "yshift", yshift);
    print_neg_shift("relu", "yshift - xshift", yshift - xshift);
    other_cnt++;
    for (int idx = 0; idx < channels * height * width; idx++)
        x[idx] = max(0, x[idx]) << (yshift - xshift);
}


constexpr int celushifts[2] = {17, 17};
int celu_cnt = 0;

void celu(qaint* x, const int channels, const int height, const int width) {
    const int xshift = celushifts[celu_cnt];
    celu_cnt = 1 - celu_cnt;
    for (int idx = 0; idx < channels * height * width; idx++) {
        const float xx = x[idx] / (float) (1 << xshift);
        x[idx] = max(0, x[idx] << (sigshift - xshift)) + min(0, (int) ((exp(xx) - 1) * (1 << sigshift)));
    }
}


void Sigmoid(qaint* x, const int channels, const int height, const int width) {
    const int xshift = cout_shifts[conv_cnt-1];
    if (xshift < tbshift) print3("xshift < tbshift:", xshift, tbshift);

    for (int idx = 0; idx < channels * height * width; idx++) {
        const qtint tb_idx = abs(x[idx]) >> (xshift - tbshift);
        const bool sign = x[idx] >= 0;
        x[idx] = tb_idx >= (1 << tbbit) ? ((qaint) sign) << sigshift :
                 sign ? Sigmoid_table[tb_idx] :
                 (1 << sigshift) - Sigmoid_table[tb_idx];
    }
}
